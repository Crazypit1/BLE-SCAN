# План создания приложения BLE-сканирования

## 1. Цель проекта

Приложение для **сканирования BLE-устройств** на базе **ESP32-C3 Super Mini**: обнаружение устройств и вывод информации в Serial Monitor. Только сканирование, без фильтрации и без подключения к устройствам. Типичный передатчик в сценарии — **ESP32 (esp32dev)**.

---

## 2. Стек и окружение

| Компонент        | Выбор                    |
|------------------|--------------------------|
| Плата (сканер)   | ESP32-C3 Super Mini      |
| Передатчик       | ESP32 (esp32dev) или **ESP32-C3** (оба варианта проверены) |
| Среда            | PlatformIO + Arduino     |
| BLE              | NimBLE (Extended Scan, 1M + Coded PHY) |
| Вывод            | Serial (USB CDC, 115200) |

**Проверено:** конфигурация **сканер + передатчик оба на ESP32-C3** работает стабильно (единый BLE 5, оба диапазона PHY).

---

## 2.1 Legacy vs Extended Advertising (BLE 4.x / 5.0)

- **Legacy Advertising** (BLE 4.0/4.2) — видят все: старые модули (HM-10, HC-05), ESP32, телефоны.
- **Extended Advertising** (BLE 5.0+) — видят только приёмники с поддержкой BLE 5 (телефоны, ESP32-C3/S3 с расширенным сканом).

**Если передатчик шлёт только Extended**, а приёмник умеет только Legacy — устройство **не видно**. Телефон видит оба формата.

**Передатчик в нашем сценарии:** **ESP32 (esp32dev)** — классический ESP32 поддерживает только BLE 4.2 и **только Legacy Advertising**. Его видят и наш сканер (ESP32-C3), и старые приёмники (HM-10, HC-05). Принудительно переключать рекламу в Legacy не нужно.

**Если передатчик — ESP32-C3/S3:** там возможен Extended; для совместимости со старыми приёмниками рекламу нужно принудительно настроить в режиме **Legacy**.  
**Приёмник (наш сканер):** ESP32-C3, стек **NimBLE** — `CONFIG_BT_NIMBLE_EXT_ADV=1` + `setPhy(SCAN_ALL)`. Видны Legacy и Extended объявления (1M + Coded PHY).

### 2.2 PHY: 1M vs 2M vs Coded (BLE 5)

- **1M PHY** — стандарт 1 Мбит/с (BLE 4.x и 5), все его поддерживают.
- **2M PHY** и **Coded PHY** (дальнобойный) — опции BLE 5. Телефон переключается автоматически; наш сканер — нет.

**Проблема:** передатчик вещает на Coded PHY или 2M PHY, а приёмник слушает только 1M → **не слышим**. И наоборот.

**Решение (если не слышно передатчик):** оба на **1M PHY** — тогда в коде сканера временно поставить `setPhy(SCAN_1M)`.  
**Сейчас:** сканер с **`setPhy(SCAN_ALL)`** — принимает оба диапазона (1M и Coded), как телефон.

### 2.3 Тип адреса: PUBLIC и RANDOM

**Проблема:** если приёмник настроен на приём только устройств с адресом типа **RANDOM** (часто в примерах под BLE 5), он **игнорирует** пакеты с адресом **PUBLIC**. И наоборот.

**Решение:** в сканере нет фильтра по типу адреса — `setFilterPolicy(0)` (NO_WL) и `setLimitedOnly(false)`. Принимаем и PUBLIC, и RANDOM.

---

## 3. Этапы разработки

### Этап 1: Базовая структура проекта

- [ ] Создать `src/main.cpp`.
- [ ] Подключить BLE-стек (NimBLE рекомендуется для сканирования на ESP32).
- [ ] Инициализация Serial, проверка вывода в мониторе.
- [ ] Базовая инициализация BLE.

**Результат:** проект собирается, плата выводит сообщения в Serial.

---

### Этап 2: Сканирование BLE-устройств

- [ ] Запуск BLE-сканирования (непрерывно или по таймеру).
- [ ] Обработка callback'ов при обнаружении устройства:
  - MAC-адрес (BLE Address)
  - Имя устройства (если есть)
  - RSSI (уровень сигнала)
  - Тип адреса (public/random)
- [ ] Вывод в Serial в читаемом формате (таблица или построчно).
- [ ] Ограничение дубликатов: один девайс = одна строка (обновление RSSI при повторном появлении).

**Результат:** в Serial виден список найденных BLE-устройств с адресом, именем и RSSI.

---

### Этап 3: Логирование (по желанию)

- [ ] Метка времени при выводе (если нужна).
- [ ] Подсчёт количества уникальных устройств за сессию.
- [ ] (Опционально) вывод advertisement-данных (Service UUID, Manufacturer Data) для отладки.

**Результат:** удобная отладка и анализ эфира.

---

### Этап 4: Улучшения (по желанию)

- [ ] Управление через Serial-команды (старт/стоп сканирования).
- [ ] Индикация на встроенном LED при обнаружении устройства.
- [ ] Поддержка кнопки на плате для старта/остановки сканирования.

---

## 4. Структура файлов

```
BLE-SCAN/
├── platformio.ini
├── PLAN.md
├── src/
│   ├── main.cpp            # точка входа, сканирование и вывод
│   └── ble_scanner.h/cpp   # (опционально) логика сканирования
└── lib/
```

---

## 5. Зависимости (PlatformIO)

Для BLE-сканирования на ESP32 можно использовать встроенный стек. При выборе **NimBLE** в `platformio.ini`:

```ini
lib_deps = 
    nimble/NimBLE-Arduino @ ^1.4.0
```

---

## 6. Критерии готовности

- Сканирование запускается и стабильно работает.
- В Serial виден список устройств с адресом, именем и RSSI.
- Дубликаты сводятся к одной строке с обновлением RSSI.

---

## 7. Порядок выполнения

1. **Этап 1** → **Этап 2** — базовое рабочее сканирование.
2. По желанию: **Этап 3** (логирование), **Этап 4** (команды, LED, кнопка).

Можно начинать с создания `src/main.cpp` и реализации Этапов 1–2.
